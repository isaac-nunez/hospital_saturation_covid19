---
title: "Intubación covid-19"
output:
  word_document: default
  html_notebook: default
---

El objetivo de este trabajo es ver quien se intuba, quien no se intuba, quien se muere sin intubarse y cuáles son los factores asociados a estos desenlaces. 
La hipótesis es que las personas mayores se intuban menos, se mueren más y que la saturación del hospital en particular al que acuden determina si cualquiera recibe tubo o no.

```{r needed packages and saved dataframes, include = F}
library(tidyverse);library(data.table);library(lubridate); library(zoo); library(patchwork);library(forestplot)
library(rms); library(kableExtra)

#load("base_cdmx_v1.RDa")
Sys.setlocale("LC_ALL", locale= "English")
```

Base de Ciudad de México. Aquí lo importante es obtener quienes fueron intubadxs y en donde, además de si fallecieron o no.
```{r definición de caso CDMX, include = F, run = T, echo = F, warnings= F}
base_cdmx_v1 <- fread("E:/Protocolos de investigación/CDMX/Actas de defunción/sisver_cdmx_27_04_2021_actualizacion_16_04.csv")[,                                                                                                                               fec_defuncion := ymd(fecdef)][, resultado_final := if_else(antigencovid == "POSITIVO" | resdefin == "SARS-CoV-2", T, F)]

#Data for selection flowchart
table(base_cdmx_v1$tipacien)
patients_included_1 <- filter(base_cdmx_v1, tipacien == "HOSPITALIZADO")

patients_included_2 <- filter(patients_included_1, (fecingre >= "2020-05-08"&
                                 fecingre <= "2021-01-05"))

nrow(patients_included_1)-nrow(patients_included_2)
nrow(patients_included_2)

patients_included_3 <- filter(patients_included_2, sector!="CRUZ ROJA"&
                                sector!="ESTATAL"&
                                sector!="UNIVERSITARIO")
nrow(patients_included_2)-nrow(patients_included_3)
nrow(patients_included_3)
```

Base de actas de defunción. Aquí lo importante es determinar si las fechas son iguales a las que se reportan en la base de covid de la SISVER y si las defunciones fueron o no fueron en casa.
```{r actas, include = F, warning = F}
base_actas_v1 <- fread("E:/Protocolos de investigación/CDMX/Defunciones corte 15 de marzo 2021/defunciones_corte15marzo.csv")[, sexo := if_else(sexo == "Mujer", "FEMENINO", "MASCULINO")][,
  fec_defuncion := ymd(fec_defuncion)
][,tipacien := if_else(lugarmuerte == "Hospital", "HOSPITALIZADO", "AMBULATORIO")][causa != "Otra",][, entresi := estado][,mpioresi:=alcaldia]
```

Base de ocupacion hospitalaria. Lo importante de esta base es unirla con la de SISVER para ver cuál era la ocupación hospitalaria al ingreso de cada paciente. Esto es vital porque es muy diferente si un paciente ingresa a un hospital con ocupación del 100% o del 10%, aunque el promedio estatal sea de 20%.

Me falta hacer lo mismo que hice en este chunk (los rolling means) pero para probabilidad de morir sin intubarse. Lo que se me ocurre es definir la variable de morir sin intubarse como el porcentaje que murieron un determinado día en los hospitales sin intubarse, pero eso podría ser dificil porque quizá no todos los días murió gente.
```{r capacidad hospitalaria, include = F, warning=F}
base_capacidad_v1 <- fread("E:/Protocolos de investigación/CDMX/capacidad_hospitalaria_micrositio_cdmx.csv")

n_distinct(base_capacidad_v1$Nombre_hospital)
table(base_cdmx_v1$unidad[base_cdmx_v1$tipacien == "HOSPITALIZADO"])

`%!in%` <- Negate(`%in%`)

#Base ocupación de cada sistema de salud
base_ocupacion_manual <- read_csv("~/Protocolos de investigación/Intubacion covid mexico/intubacion_covid/base_ocupacion_manual.csv") %>% 
  rename(porcentaje_disponibles = porcentaje) %>% 
  mutate(fecha = dmy(fecha),
         num_fila = row_number())
 
intermed <-  base_ocupacion_manual %>% 
  filter(fecha>=dmy("06-01-2021") & sector =="privados") 
  
base_ocupacion_manual_2 <- base_ocupacion_manual %>% 
  filter(num_fila %!in% intermed$num_fila) %>% 
  group_by(sector, tipo_cama, fecha) %>% 
  arrange(.by_group = T) %>% 
  ungroup() %>% 
  mutate(disponibles_mod = if_else(!is.na(disponibles), disponibles, 
                                 round((na.locf(disponibles, fromLast = F)+
                                   na.locf(disponibles, fromLast = T))/2,0)),
         porcentaje_disponibles_mod = if_else(!is.na(porcentaje_disponibles), 
                                              porcentaje_disponibles, 
                                 round((na.locf(porcentaje_disponibles, fromLast = F)+
                                   na.locf(porcentaje_disponibles, fromLast = T))/2,1)),
         porcentaje_ocupadas = 100-porcentaje_disponibles,
         capacidad = round((disponibles*100)/porcentaje_disponibles, 0),
         porcentaje_ocupadas_mod = 100-porcentaje_disponibles_mod,
         capacidad_mod = round((disponibles_mod*100)/porcentaje_disponibles_mod, 0))
         

  
  



ejemplo <- ggplot(filter(base_ocupacion_manual_2, sector == "cdmx"), aes(x=fecha, y = rollmean(porcentaje_ocupadas_mod, 7,align="right", fill = NA), colour = tipo_cama))+
  geom_line(size = 1)+
  scale_x_date(date_breaks = "1 month",
               date_labels ="%b %y")+
  scale_y_continuous(breaks = seq(from = 0, to = 100, by = 10),
                     limits = c(0, 100))+
  theme_bw()+
  ggtitle("Negative case definition")+
  labs(y="",
       x="Date",
       title = "B")+
  theme(legend.position="bottom",
    axis.text.x = element_text(angle = 90, vjust = .25, hjust = 0.95, 
                               size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"))



rollmean(filter(base_ocupacion_manual_2, sector == "cdmx"&tipo_cama == "iot")$porcentaje_ocupadas_mod, 7,align="right",fill = NA)
```


Unión base SISVER con base actas de defunción
En los métodos especifico que primero voy a ver qué información tengo en la base MxCov. En caso de no tener una prueba para COVID-19 positiva, entonces veré si en la base de actas de defunción tengo algo de información al respecto. Por lo tanto, aquí abajo sólo estoy uniendo las que no tuvieron covid según el resultado de la prueba, pero si lo tienen como al menos sospechoso en las actas de defunción.
Creo que sale mejor hacer el join en base a las actas de defunción, porque en teoría esta información es más exacta. Punto adicional, creo que habría que tratar a todas las personas que sean "sospecha de covid" o "covid confirmado" de la misma manera, porque las infecciones respiratorias se están tratando igual en pandemia.

A destacar, hay dos pacientes que tienen causa de muerte como COVID-19 confirmado que murieron el 30 de enero del 2020, desconocemos si este diagnóstico se hizo de manera retrospectiva o si es un error.

Tengo evidencia de una infraestimación considerable del número de pacientes que murieron dentro del hospital. Hasta donde puedo ver, esto es lo único que aporta la base de datos de mortalidad (además de quizá un poco sobre la causa de muerte), pero realmente no me está ayudando en mi hipótesis del estudio, entonces parece que de entrada lo tendré que hacer únicamente con la base de cdmx y agregar la variable de saturación del hospital.
```{r cdmx actas y sisver}
base_cdmx_actas <- base_actas_v1[tipacien == "HOSPITALIZADO",] %>% 
  left_join(base_cdmx_v1[!is.na(fec_defuncion)&fec_defuncion<="2021-02-27",][tipacien == "HOSPITALIZADO",], by = c("fec_defuncion","edad","sexo", "tipacien", "entresi")) %>% 
  filter(!is.na(id))

#La base de COVID-19 de la ciudad de México tiene nada más 18937 muertes registradas por covid-19

ej <- filter(base_cdmx_actas, !is.na(id))

#Qué tanto nos aporta el municipio de residencia en cuanto a presición del match?
ej_2 <- base_cdmx_v1[!is.na(fec_defuncion)&fec_defuncion<="2021-02-27",][tipacien == "HOSPITALIZADO",]
#entresi entidad de residencia
#mpioresi municipio de residencia

base_cdmx_actas %>% 
  group_by(id) %>% 
  count() %>% 
  arrange(by = n, desc())




```

Nuestra muestra pivote van a ser puros hospitalizados. Aquellos que no requirieron tubo y no murieron, quienes fueron intubados (independientemente de si murieron o no) y quienes murieron sin ser intubados.


No está el reporte con fecha del día 13 de junio (es decir, con los datos de hospitalización del día 12). En la página repiten el reporte del día 14 (error de dedo probablemente).
No están los datos del 14 de mayo del año pasado, los datos del 18 de mayo se repiten (es decir, los datos que vienen en el reporte dle 18 y del 19 son los mismos).
En el reporte de agosto 27 sale como fecha de corte de los datos de hospitalización el 25 de agosto, pero los datos son diferentes a los del reporte del 26 de agosto, entonces parece que fue error de dedo y si representa los datos del 26.
```{r base final, include = F, warning=F}

base_cdmx_v2 <- base_cdmx_v1[tipacien == "HOSPITALIZADO",][,
                                                           `:=`(iot = if_else(intubado == "SI", T, F),
                                                             clasif_paciente = if_else(intubado == "SI", "intubado",
                                                                                       if_else(evoluci == "DEFUNCION",
                                                                                               "muerte_sin_tubo",
                                                                                               "leve")),
                                                             defuncion = if_else(evoluci == "DEFUNCION"|
                                                                                   !is.na(fec_defuncion), T, F),
                                                             hosp_privado = if_else(sector == "PRIVADA", T, F),
                                                             diabetes = if_else(diabetes == "SI", T, F),
                                                             hiperten = if_else(hiperten == "SI", T, F),
                                                             obesidad = if_else(obesidad == "SI", T, F)
                                                           )]


glimpse(base_capacidad_v1)
ej_4 <- filter(base_capacidad_v1, Nombre_hospital %in% base_cdmx_v2$unidad)
```


```{r rollmeans, include= F, warning=F}
muertes_covid <- mutate(base_cdmx_v2, fecdef = ymd(fecdef)) %>% 
  filter(defuncion == T) %>% 
  group_by(fecdef) %>% 
  summarise(num_muertes = n(),
            muertes_con_tubo = sum(iot),
            muertes_sin_tubo = sum(iot==F),
            porcentaje_muertes_con_tubo = round(sum(iot)/num_muertes*100, 1),
            porcentaje_muertes_sin_tubo = round(sum(iot==F)/num_muertes*100, 1)
            ) %>% 
  filter(fecdef >=dmy("08-05-2020"))

muertes_covid_privado <- mutate(base_cdmx_v2, fecdef = ymd(fecdef)) %>% 
  filter(defuncion == T) %>% 
  group_by(fecdef, hosp_privado) %>% 
  summarise(num_muertes = n(),
            muertes_con_tubo = sum(iot),
            muertes_sin_tubo = sum(iot==F),
            porcentaje_muertes_con_tubo = round(sum(iot)/num_muertes*100, 1),
            porcentaje_muertes_sin_tubo = round(sum(iot==F)/num_muertes*100, 1)
            ) %>% 
  filter(fecdef >=dmy("08-05-2020"))


muertes_covid_plot <- ggplot(muertes_covid, aes(x=fecdef, y = rollmean(porcentaje_muertes_sin_tubo, 7,
                                            align="right", fill = NA)))+
  geom_hline(yintercept = 50, color = "gray", size = 0.5)+
  geom_line(size = 2)+
  scale_y_continuous(breaks = seq(from=0, to=100, by = 10),
                     limits= c(0,100))+
  scale_x_date(date_breaks = "1 month",
               date_labels ="%b %y")+
  scale_colour_brewer(palette="Dark2")+
  theme_bw()+
  ggtitle("Muertes en pacientes hospitalizados por COVID-19 sin IOT")+
  labs(y="Muertes por COVID-19 sin recibir IOT (%)",
       x="Date")+
  theme(legend.position="none",
        axis.text.x = element_text(angle = 90, vjust = .25, hjust = 0.95, 
                                   size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  geom_line(data = filter(base_ocupacion_manual_2, sector == "cdmx" & fecha >="2020-05-08" 
                            & fecha <="2021-04-19"), aes(x=fecha, y = rollmean(porcentaje_ocupadas_mod, 7,align="right", fill = NA), colour = tipo_cama), size = 2)+
  theme(legend.position = "bottom")


muertes_covid_privado_plot <- ggplot(muertes_covid_privado, aes(x=fecdef, y = rollmean(porcentaje_muertes_sin_tubo, 7,
                                            align="right", fill = NA), colour = hosp_privado))+
  geom_hline(yintercept = 50, color = "gray", size = 0.5)+
  geom_line(size = 1)+
  scale_y_continuous(breaks = seq(from=0, to=100, by = 10),
                     limits= c(0,100))+
  scale_x_date(date_breaks = "1 month",
               date_labels ="%b %y")+
  scale_colour_brewer(palette="Dark2")+
  theme_bw()+
  ggtitle("Muertes en pacientes hospitalizados por COVID-19 sin IOT")+
  labs(y="Muertes por COVID-19 sin recibir IOT (%)",
       x="Date")+
  theme(legend.position="bottom",
        axis.text.x = element_text(angle = 90, vjust = .25, hjust = 0.95, 
                                   size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))
  
```


Regresión logística
Aquí tengo que manejar lo de la relación paradójica que hay entre la saturación y la probabilidad de morir sin tubo. Hasta ahora no tengo una buena explicación para eso.
```{r generando las bases para la log regression , include = F, warning= F}
base_cdmx_v3 <- base_cdmx_v2 %>%
  filter(sector != "CRUZ ROJA"&
           sector != "ESTATAL"&
           sector != "UNIVERSITARIO"&
           (fecingre>="2020-05-08"&
           fecingre<="2021-04-19")) %>% 
  mutate(sector = if_else(sector != "PRIVADA", tolower(sector), "privados"),
         fecha= ymd(fecingre)) %>% 
  left_join(filter(base_ocupacion_manual_2, 
                   sector != "sedesa"&
                     sector!="cdmx" & tipo_cama == "iot") %>% 
              mutate(fecha = fecha), by = c("fecha", "sector")) %>%
  left_join(filter(base_ocupacion_manual_2, 
                   sector != "sedesa"&
                     sector!="cdmx" & tipo_cama == "general") %>% 
              mutate(fecha = fecha) %>% 
              rename(tipo_cama_gral = tipo_cama, 
                     disponibles_gral = disponibles, 
                     porcentaje_disponibles_gral = porcentaje_disponibles,
                     num_fila_gral = num_fila, 
                     disponibles_mod_gral = disponibles_mod,
                     porcentaje_disponibles_mod_gral = porcentaje_disponibles_mod,
                     porcentaje_ocupadas_gral = porcentaje_ocupadas,
                     capacidad_gral = capacidad,
                     porcentaje_ocupadas_mod_gral = porcentaje_ocupadas_mod,
                     capacidad_mod_gral = capacidad_mod), by = c("fecha", "sector")) %>% 
  filter(fecingre <= "2021-01-05") %>% 
  mutate(clasif_paciente_num = if_else(clasif_paciente=="muerte_sin_tubo", T,F),
         semana = if_else(year(fecingre)=="2020",
                          week(fecingre),
                          week(fecingre)+53),
         resultado_final_modificado = resultado_final,
         cociente_iot_generales = if_else(disponibles_mod_gral != 0 , 
                                       disponibles_mod/disponibles_mod_gral,
                                       100))


#Proof of repetition of multiple death certificates
id_base_cdmx_negativos <- filter(base_cdmx_v3, resultado_final == F & 
                                clasif_paciente_num == T) %>% 
  left_join(base_actas_v1, by = c("fec_defuncion", "sexo", "edad", "tipacien", "entresi",
                                  "mpioresi")) %>% 
  group_by(id) %>% 
  slice(1) %>% 
  mutate(resultado_final_modificado = T)#Resultado final modificado quiere decir que si tuvieron un match en la base de defunciones y por ende consideraremos que su causa de muerte fue COVID-19 (por lo tanto, que si tenían diagnóstico de covid-19)


#Registros de quienes murieron sin VMI y no tuvieron diagnóstico de COVID-19
reg_negativos <- filter(base_cdmx_v3, resultado_final == F & 
                                clasif_paciente_num == T) %>% 
  select("id")#Es el mismo número de id diferentes que tuvieron un match en la base de datos de defunciones, por lo tanto nos ahorraremos un filtro


#selection of only one patient patient of the multiple repeated matches
base_cdmx_v4 <- base_cdmx_v3 %>% 
  mutate(resultado_final_modificado = if_else(id %in% id_base_cdmx_negativos$id, 
                                              T, resultado_final_modificado),
         disnea = if_else(disnea == "SI", T, F))
   

```


#Para ver cómo están las tendencias hay que ver si la proporción de personas que se murieron en el hospital vs en el domicilio cambió a lo largo del tiempo, o si es algo que tenemos que incluir en el modelo (como semana epidemiológica)
```{r  log regression , include = F, warning= F}
set.seed(12345)

ind <- sample(c(0,1), nrow(base_cdmx_v4), replace = T, prob= c(0.7, 0.3))

train <- base_cdmx_v4[ind==1,]
test <- base_cdmx_v4[ind==2,]

#Semana epidemiológica
mymodel_semana_epi <- glm(clasif_paciente_num ~ semana, data = train, family = 'binomial')
summary(mymodel_semana_epi)
exp(coef(mymodel_semana_epi))
exp(coef(mymodel_semana_epi)-(1.96*0.002))
exp(coef(mymodel_semana_epi)+(1.96*0.002))

lr_semana <- termplot(mymodel_semana_epi, se=TRUE, plot = F)$semana
center_semana <- with(lr_semana, y[x==37])
ci_semana <- lr_semana$y + outer(lr_semana$se, c(0, -1.96, 1.96), '*')

semana_df <- data.frame(semana_epi = lr_semana$x, 
                     y = lr_semana$y,
                     se = lr_semana$se,
                     lower_ci = ci_semana[,2],
                     upper_ci = ci_semana[,3],
                     mean_ci = ci_semana[,1])

semana_ors <- semana_df[with(semana_df, semana_epi == 19 | semana_epi == 27 | semana_epi == 37 | 
                         semana_epi == 47 |semana_epi== 54),] %>% 
  mutate(or = exp(y-center_semana),
         lower_or = round(exp(lower_ci-center_semana),2),
         upper_or = round(exp(upper_ci-center_semana),2),
         full_or = str_c(round(exp(y-center_semana),2), " (", round(exp(lower_ci-center_semana),2),
                         "-", round(exp(upper_ci-center_semana),2),")"))

#Estatus socioeconómico (hospital privado)
mymodel_hosp_privado <- glm(clasif_paciente_num ~ hosp_privado + diabetes + hiperten + obesidad, data = train, family = 'binomial')
summary(mymodel_hosp_privado)
hosp_privado_or <- c(round(exp(coef(mymodel_hosp_privado)),2)[2],
                            round(exp(coef(mymodel_hosp_privado)-(1.96*0.183)),2)[2],
                            round(exp(coef(mymodel_hosp_privado)+(1.96*0.183)),2)[2])
hosp_privado_or_ic <- str_c(round(exp(coef(mymodel_hosp_privado)),2)[2],
                            " (", round(exp(coef(mymodel_hosp_privado)-(1.96*0.183)),2)[2], "-",
                            round(exp(coef(mymodel_hosp_privado)+(1.96*0.183)),2)[2],")")

#edad
mymodel_edad <- glm(clasif_paciente_num ~ rcs(edad, 3) +
                      diabetes+hiperten+obesidad, data = train, family = 'binomial')
summary(mymodel_edad)
exp(coef(mymodel_edad))
exp(coef(mymodel_edad)-(1.96*0.004))
exp(coef(mymodel_edad)+(1.96*0.004))#The average of the standard errors was used

lr_edad <- termplot(mymodel_edad, se=TRUE, plot = F)$edad
center_edad <- with(lr_edad, y[x==50])
ci_edad <- lr_edad$y + outer(lr_edad$se, c(0, -1.96, 1.96), '*')

edad_df <- data.frame(edad = lr_edad$x, 
                     y = lr_edad$y,
                     se = lr_edad$se,
                     lower_ci = ci_edad[,2],
                     upper_ci = ci_edad[,3],
                     mean_ci = ci_edad[,1])


edad_ors <- edad_df[with(edad_df, edad == 20 | edad == 30 | edad == 40 | 
                         edad == 50 |edad== 60|edad== 70|edad== 80),] %>% 
  mutate(or = round(exp(y-center_edad),2),
         lower_or = round(exp(lower_ci-center_edad),2),
         upper_or = round(exp(upper_ci-center_edad),2),
         full_or = str_c(round(exp(y-center_edad),2), " (", round(exp(lower_ci-center_edad),2),
                         "-", round(exp(upper_ci-center_edad),2),")"))

#porcentaje de ocupacion de camas criticas, checar por qué me sale este porcentaje
mymodel_ocupadas <- glm(clasif_paciente_num ~ rcs(porcentaje_ocupadas_mod,3) + semana, data = train, family = 'binomial')
summary(mymodel_ocupadas)
exp(coef(mymodel_ocupadas))
exp(coef(mymodel_ocupadas)-(1.96*0.0029))
exp(coef(mymodel_ocupadas)+(1.96*0.0029))

lr_ocupadas <- termplot(mymodel_ocupadas, se=TRUE, plot = F)$porcentaje_ocupadas_mod
center_ocupadas <- with(lr_ocupadas, y[x==50])
ci_ocupadas <- lr_ocupadas$y + outer(lr_ocupadas$se, c(0, -1.96, 1.96), '*')

ocupadas_df <- data.frame(porcentaje_ocupadas = lr_ocupadas$x, 
                     y = lr_ocupadas$y,
                     se = lr_ocupadas$se,
                     lower_ci = ci_ocupadas[,2],
                     upper_ci = ci_ocupadas[,3],
                     mean_ci = ci_ocupadas[,1])


ocupadas_ors <- ocupadas_df[with(ocupadas_df, porcentaje_ocupadas == 20.3| porcentaje_ocupadas == 30.0 | porcentaje_ocupadas == 50 |
                                   porcentaje_ocupadas== 70|
                                   porcentaje_ocupadas== 90),] %>% 
  mutate(or = round(exp(y-center_ocupadas),2),
         lower_or = round(exp(lower_ci-center_ocupadas),2),
         upper_or = round(exp(upper_ci-center_ocupadas),2),
         full_or = str_c(round(exp(y-center_ocupadas),2), " (", round(exp(lower_ci-center_ocupadas),2),
                         "-", round(exp(upper_ci-center_ocupadas),2),")"))

#Porcentaje ocupación camas generales
#porcentaje de ocupacion de camas criticas, checar por qué me sale este porcentaje
mymodel_ocupadas_gral <- glm(clasif_paciente_num ~ rcs(porcentaje_ocupadas_mod_gral,3) + semana, data = train, family = 'binomial')
summary(mymodel_ocupadas_gral)
exp(coef(mymodel_ocupadas_gral))
exp(coef(mymodel_ocupadas_gral)-(1.96*0.0045))
exp(coef(mymodel_ocupadas_gral)+(1.96*0.0045))

lr_ocupadas_gral <- termplot(mymodel_ocupadas_gral, se=TRUE, plot = F)$porcentaje_ocupadas_mod_gral
center_ocupadas_gral <- with(lr_ocupadas_gral, y[x==50])
ci_ocupadas_gral <- lr_ocupadas_gral$y + outer(lr_ocupadas_gral$se, c(0, -1.96, 1.96), '*')

ocupadas_gral_df <- data.frame(porcentaje_ocupadas_gral = round(lr_ocupadas_gral$x,3), 
                     y = lr_ocupadas_gral$y,
                     se = lr_ocupadas_gral$se,
                     lower_ci = ci_ocupadas_gral[,2],
                     upper_ci = ci_ocupadas_gral[,3],
                     mean_ci = ci_ocupadas_gral[,1])


ocupadas_gral_ors <- ocupadas_gral_df[with(ocupadas_gral_df, porcentaje_ocupadas_gral ==30.0| 
                                             porcentaje_ocupadas_gral == 50 |porcentaje_ocupadas_gral== 70|
                                   porcentaje_ocupadas_gral== 89.8),] %>% 
  mutate(or = round(exp(y-center_ocupadas_gral),2),
         lower_or = round(exp(lower_ci-center_ocupadas_gral),2),
         upper_or = round(exp(upper_ci-center_ocupadas_gral),2),
         full_or = str_c(round(exp(y-center_ocupadas_gral),2), " (", round(exp(lower_ci-center_ocupadas_gral),2),
                         "-", round(exp(upper_ci-center_ocupadas_gral),2),")"))
#DIABETES
mymodel_diabetes <- glm(clasif_paciente_num ~ diabetes +
                          rcs(edad,3) +hosp_privado , data = train, family = 'binomial')
summary(mymodel_diabetes)
round(exp(coef(mymodel_diabetes)),2)
round(exp(coef(mymodel_diabetes)-(1.96*0.051)),2)
round(exp(coef(mymodel_diabetes)+(1.96*0.051)),2)
diabetes_or <- c(round(exp(coef(mymodel_diabetes)),2)[2],
                             round(exp(coef(mymodel_diabetes)-(1.96*0.051)),2)[2],
                            round(exp(coef(mymodel_diabetes)+(1.96*0.051)),2)[2])
diabetes_or_ic <- str_c(round(exp(coef(mymodel_diabetes)),2)[2],
                            " (", round(exp(coef(mymodel_diabetes)-(1.96*0.051)),2)[2], "-",
                            round(exp(coef(mymodel_diabetes)+(1.96*0.051)),2)[2],")")


#HIPERTENSION
mymodel_hipertension <- glm(clasif_paciente_num ~ hiperten+rcs(edad,3) +hosp_privado
                              , data = train, family = 'binomial')
summary(mymodel_hipertension)
hypertension_or <- c(round(exp(coef(mymodel_hipertension)),2)[2],
                      round(exp(coef(mymodel_hipertension)-(1.96*0.051)),2)[2],
                            round(exp(coef(mymodel_hipertension)+(1.96*0.051)),2)[2])
hypertension_or_ic <- str_c(round(exp(coef(mymodel_hipertension)),2)[2],
                            " (", round(exp(coef(mymodel_hipertension)-(1.96*0.051)),2)[2], "-",
                            round(exp(coef(mymodel_hipertension)+(1.96*0.051)),2)[2],")")

#OBESIDAD
mymodel_obesidad <- glm(clasif_paciente_num ~ obesidad+rcs(edad,3) +hosp_privado, data = train, family = 'binomial')
summary(mymodel_obesidad)
obesidad_or <- round(c(exp(coef(mymodel_obesidad))[2],exp(coef(mymodel_obesidad)-(1.96*0.061))[2],
                 exp(coef(mymodel_obesidad)+(1.96*0.061))[2]),2)

obesity_or_ic <- str_c(round(exp(coef(mymodel_obesidad)),2)[2],
                            " (", round(exp(coef(mymodel_obesidad)-(1.96*0.061)),2)[2], "-",
                            round(exp(coef(mymodel_obesidad)+(1.96*0.061)),2)[2],")")

#DISNEA
mymodel_disnea <- glm(clasif_paciente_num ~ disnea+rcs(edad,3) +hosp_privado
                      , data = train, family = 'binomial')
summary(mymodel_disnea)
disnea_or <- c(round(exp(coef(mymodel_disnea)),2)[2],round(exp(coef(mymodel_disnea)-(1.96*0.059)),2)[2],
               round(exp(coef(mymodel_disnea)+(1.96*0.059)),2)[2])
disnea_or_ic <- str_c(round(exp(coef(mymodel_disnea)),2)[2],
                            " (", round(exp(coef(mymodel_disnea)-(1.96*0.059)),2)[2], "-",
                            round(exp(coef(mymodel_disnea)+(1.96*0.059)),2)[2],")")

#Cociente IOT/camas generales
mymodel_cociente_iot <- glm(clasif_paciente_num ~ rcs(cociente_iot_generales,3)+ 
                              semana, data = train, family = 'binomial')
summary(mymodel_cociente_iot)
round(exp(coef(mymodel_cociente_iot)),2)
round(exp(coef(mymodel_cociente_iot)-(1.96*0.275)),2)
round(exp(coef(mymodel_cociente_iot)+(1.96*0.275)),2)

lr_cociente_iot <- termplot(mymodel_cociente_iot, se=TRUE, plot = F)$cociente_iot
center_cociente_iot <- with(lr_cociente_iot, y[x==0.5])
ci_cociente_iot <- lr_cociente_iot$y + outer(lr_cociente_iot$se, c(0, -1.96, 1.96), '*')

cociente_iot_df <- data.frame(cociente_iot = round(lr_cociente_iot$x,3), 
                     y = round(lr_cociente_iot$y,3),
                     se = round(lr_cociente_iot$se,3),
                     lower_ci = ci_cociente_iot[,2],
                     upper_ci = ci_cociente_iot[,3],
                     mean_ci = ci_cociente_iot[,1])


cociente_iot_ors <- cociente_iot_df[with(cociente_iot_df, cociente_iot == 0.105 | cociente_iot == 0.299|cociente_iot == 0.500 | cociente_iot == 0.800 |cociente_iot== 1|cociente_iot== 2.1),] %>% 
  mutate(or = round(exp(y-center_cociente_iot),2),
         lower_or = round(exp(lower_ci-center_cociente_iot),2),
         upper_or = round(exp(upper_ci-center_cociente_iot),2),
         full_or = str_c(round(exp(y-center_cociente_iot),2), " (", round(exp(lower_ci-center_cociente_iot),2),
                         "-", round(exp(upper_ci-center_cociente_iot),2),")")) %>% 
  group_by(cociente_iot) %>% slice(1)
```

```{r table 1, include = F, warning = F}
table_1 <- group_by(base_cdmx_v4, clasif_paciente) %>% 
  summarise(n=n(),
            sexo_masc = str_c(sum(sexo=="MASCULINO"), " (",round(sum(sexo=="MASCULINO")/n, 3)*100, ")"),
            sexo_fem = str_c(sum(sexo=="FEMENINO"), " (",round(sum(sexo=="FEMENINO")/n, 3)*100, ")"),
            edad_mediana = str_c(median(edad), " (", fivenum(edad)[2], "-", fivenum(edad)[4], ")"),
            resultado_final = str_c(sum(resultado_final), " (", round(sum(resultado_final)/n, 3)*100, ")"),
            diabetes = str_c(sum(diabetes), " (", round(sum(diabetes)/n, 3)*100, ")"),
            hipertension = str_c(sum(hiperten), " (", round(sum(hiperten)/n, 3)*100, ")"),
            obesidad = str_c(sum(obesidad), " (", round(sum(obesidad)/n, 3)*100, ")"),
            disnea = str_c(sum(disnea), " (", round(sum(disnea)/n, 3)*100, ")"),
            vih_sida = str_c(sum(vih_sida=="SI"), " (", round(sum(vih_sida=="SI")/n, 3)*100, ")"),
            cardiopatia = str_c(sum(enfcardi=="SI"), " (", round(sum(enfcardi=="SI")/n, 3)*100, ")"),
            hosp_privado = str_c(sum(hosp_privado), " (", round(sum(hosp_privado)/n, 3)*100, ")"),
            muertes = str_c(sum(!is.na(fecdef)), " (", round(sum(!is.na(fecdef))/n, 3)*100, ")")) 

#Total of patients included
19820+5416+8569
#Individual proportions
19820/(19820+5416+8569)
5416/(19820+5416+8569)
8569/(19820+5416+8569)

```

```{r table 2, include = T, warning=F}
table_2 <- data.frame(variables = c("Epidemiological week", semana_ors$semana_epi,
                                              "Age", edad_ors$edad,
                                              "Private healthcare",
                                              "Percentage occupation of IMV-capable beds",
                                              ocupadas_ors$porcentaje_ocupadas,
                                              "Percentage occupation of general beds",
                                    round(ocupadas_gral_ors$porcentaje_ocupadas_gral,0),
                                              "IMV-capable to general bed ratio",
                                              round(cociente_iot_ors$cociente_iot,2),
                                              "Diabetes",
                                              "Hypertension",
                                              "Obesity",
                                              "Dyspnea"),
                      or_ic = c(NA, semana_ors$full_or,
                                NA, edad_ors$full_or,
                                hosp_privado_or_ic,
                                NA, ocupadas_ors$full_or,
                                NA, ocupadas_gral_ors$full_or,
                                NA, cociente_iot_ors$full_or,
                                 diabetes_or_ic,
                                 hypertension_or_ic,
                                 obesity_or_ic,
                                 disnea_or_ic))
```


```{r table forest plot, include = T, warning=F}
table_forest_plot <- data.frame(variables = c("Private healthcare",
                                              "Diabetes",
                                              "Hypertension",
                                              "Obesity",
                                              "Dyspnea"),
                                media = c(hosp_privado_or[1],
                                          diabetes_or[1],
                                          hypertension_or[1],
                                          obesidad_or[1],
                                          disnea_or[1]),
                                ci_inferior = c(hosp_privado_or[2],
                                          diabetes_or[2],
                                          hypertension_or[2],
                                          obesidad_or[2],
                                          disnea_or[2]),
                                ci_superior = c(hosp_privado_or[3],
                                          diabetes_or[3],
                                          hypertension_or[3],
                                          obesidad_or[3],
                                          disnea_or[3]))


```

```{r forestplot, include = F, warning = F}
forestplot(labeltext=as.vector(table_forest_plot$variables),
           mean = table_forest_plot$media,
           lower = table_forest_plot$ci_inferior,
           upper = table_forest_plot$ci_superior,
           xlab = "OR of death without IMV",
           grid = T,
           ci.vertices = T,
           boxsize = 0.15,
           graph.pos=3)

           hrzl_lines=list("1" = gpar(lwd=1, col="#99999922"), 
                          "2" = gpar(lwd=60, lineend="butt", columns=c(2:6), col="#99999922"),
                          "3" = gpar(lwd=60, lineend="butt", columns=c(2:6), col="#99999922"),
                          "4" = gpar(lwd=60, lineend="butt", columns=c(2:6), col="#99999922"),
                          "5" = gpar(lwd=60, lineend="butt", columns=c(2:6), col="#99999922")))
,
           txt_gp=fpTxtGp(label=gpar(cex=1.25),
                              ticks=gpar(cex=1.1),
                              xlab=gpar(cex = 1.2),
                              title=gpar(cex = 1.2)))
```

```{r spline plots for continuous variables, include = F}
semana_epi_spline_plot <- ggplot(semana_df, aes(x = semana_epi, 
                                                        y = exp(y - center_semana))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "gray") +
  geom_smooth(se = F, colour = "orange") +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(upper_ci - center_semana)), size = .5) +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(lower_ci - center_semana)), size = .5) +
  ylab("OR of death without IMV") +
  xlab("Epidemiological week")+
  theme_light()+
  ggtitle("A)")+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 3))+
  scale_x_continuous(breaks = seq(19,54,5),
                     limits = c(19, 54))

ocupacion_general_spline_plot <- ggplot(ocupadas_gral_df, aes(x = porcentaje_ocupadas_gral, 
                                                        y = exp(y - center_ocupadas_gral))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "gray") +
  geom_smooth(se = F, colour = "orange") +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(upper_ci - center_ocupadas_gral)), size = .5) +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(lower_ci - center_ocupadas_gral)), size = .5) +
  ylab("OR of death without IMV") +
  xlab("Percentage of general bed occupation")+
  ggtitle("B)")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 3))+
  scale_x_continuous(breaks = seq(20,100,20),
                     limits = c(20, 100))

ocupacion_imv_spline_plot <- ggplot(ocupadas_df, aes(x = porcentaje_ocupadas, 
                                                        y = exp(y - center_ocupadas))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "gray") +
  geom_smooth(se = F, colour = "orange") +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(upper_ci - center_ocupadas)), size = .5) +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(lower_ci - center_ocupadas)), size = .5) +
  ylab("OR of death without IMV") +
  xlab("Percentage of IMV-capable bed occupation")+
  ggtitle("C)")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 3))+
  scale_x_continuous(breaks = seq(20,100,20),
                     limits = c(20, 100))

imv_cociente_spline_plot <- ggplot(cociente_iot_df, aes(x = cociente_iot, 
                                                        y = exp(y - center_cociente_iot))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "gray") +
  geom_smooth(se = F, colour = "orange") +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(upper_ci - center_cociente_iot)), size = .5) +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(lower_ci - center_cociente_iot)), size = .5) +
  ylab("OR of death without IMV") +
  xlab("IMV-capable to general bed ratio")+
  ggtitle("D)")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 3))+
  scale_x_continuous(breaks = seq(0,3,0.5),
                     limits = c(0, 3))

edad_spline_plot <- ggplot(edad_df, aes(x = edad, 
                                                        y = exp(y - center_edad))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "gray") +
  geom_smooth(se = F, colour = "orange") +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(upper_ci - center_edad)), size = .5) +
  geom_smooth(se = F, colour = "orange", linetype = "dashed", aes(y = exp(lower_ci - center_edad)), size = .5) +
  ylab("OR of death without IMV") +
  xlab("Age (years)")+
  ggtitle("E)")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 3))+
  scale_x_continuous(breaks = seq(20,80,20),
                     limits = c(0, 90))



figura_2 <- semana_epi_spline_plot/ocupacion_general_spline_plot/ocupacion_imv_spline_plot/imv_cociente_spline_plot/edad_spline_plot#Guardar en relación 15 alto:5 ancho

```


```{r DAGitty code, include = F, run = F}
testImplications <- function( covariance.matrix, sample.size ){
	library(ggm)
	tst <- function(i){ pcor.test( pcor(i,covariance.matrix), length(i)-2, sample.size )$pvalue }
tos <- function(i){ paste(i,collapse=" ") }
implications <- list(c("Hospital saturation","Patient's age"),
		c("Hospital saturation","Patient's comorbidities"),
		c("Hospital saturation","Private healthcare"),
		c("Moment of the epidemic","Patient's age"),
		c("Moment of the epidemic","Patient's comorbidities"),
		c("Moment of the epidemic","Private healthcare"),
		c("Patient's age","Private healthcare"),
		c("Patient's comorbidities","Private healthcare"))
	data.frame( implication=unlist(lapply(implications,tos)),
		pvalue=unlist( lapply( implications, tst ) ) )

}

```

